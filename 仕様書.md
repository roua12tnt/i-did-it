# I did it! アプリケーション仕様書

## 1. 概要

### 1.1 アプリケーション名
**I did it!** - 1日3DO習慣化サポートアプリ

### 1.2 目的
毎日の目標を設定し、達成を記録することで習慣化をサポートする。ユーザーが目標を達成した際に祝福メッセージを表示し、継続的なモチベーション維持を図る。

### 1.3 基本コンセプト
- **1日3DO**: 1日最大3つまでの目標（Do）を設定
- **褒められたい**: 達成時の祝福メッセージでユーザーを励ます
- **シンプルな操作**: 直感的で使いやすいインターフェース
- **継続的な習慣化**: カレンダー表示で進捗を視覚化

## 2. 機能仕様

### 2.1 認証機能
- **実装**: Supabase Auth
- **認証方法**: メールアドレス + パスワード
- **機能**:
  - ユーザー登録（サインアップ）
  - ログイン
  - ログアウト
  - プロフィール自動作成
- **セッション管理**:
  - 自動ログアウト（セッション切れ時）
  - ログイン画面への自動リダイレクト
  - JWT/セッションエラーの検知と対応
  - ページリロード時の安定性確保（finallyブロックでローディング状態終了）
  - 読み込み長時間エラー時の自動リダイレクト（20秒タイムアウト）
  - 確実なログアウト後のログイン画面復帰
- **UI機能**:
  - パスワード表示/非表示切り替え（目のアイコンボタン）
  - アカウント作成成功時の確認メッセージ表示
  - メールアドレス認証案内メッセージ
  - ログイン画面への戻るボタン

### 2.2 Do管理機能
- **制限**: 1ユーザーあたり最大3つのDo
- **CRUD操作**:
  - 作成: タイトル（必須）、説明（任意）
  - 読み取り: ユーザーのDo一覧表示
  - 更新: Do情報の編集
  - 削除: Do削除（関連する達成記録も削除）
- **バリデーション**: データベース制約で3つ制限を強制

### 2.3 カレンダー機能
- **表示形式**: 月間カレンダー（日本語フォーマット）
- **ナビゲーション**:
  - 前月/次月移動
  - 「今日」へのクイックジャンプ
- **達成表示**:
  - 黄色の星マーク（#FFD700）で達成日を表示
  - 1日最大3つの星を表示
  - 3つ以上の場合は「+」記号で表示
- **インタラクション**:
  - 日付クリックで達成記録管理画面を表示
- **データ同期**:
  - Do管理後のカレンダー自動更新
  - エラー時の安定状態管理（空配列セット）
  - セッションエラー時の適切なハンドリング

### 2.4 達成記録機能

#### 2.4.1 記録の作成
- **操作手順**: カレンダー日付選択 → Do選択 → 星マーククリック
- **確認システム**: 30%の確率でランダム確認モーダル表示
  - 確認モーダル: 「ほんとに？」「本当！」「あとで」
  - キャンセル時は記録されない
  - 直接記録（70%）: 即座に祝福モーダル表示

#### 2.4.2 記録の削除
- **削除方法**: 達成済み記録のクリックで削除確認ダイアログ表示
- **確認機能**: 「この達成記録を削除しますか？」メッセージ
- **削除範囲**: 達成記録とメモを同時削除

#### 2.4.3 メモ機能
- **入力方法**: 祝福モーダル内の専用入力欄
- **文字制限**: 200文字以内（リアルタイム文字数表示）
- **保存方式**: メモありでもなしでも達成記録は保存
- **表示場所**: カレンダー下DoリストでDo.descriptionの代替表示
- **表示条件**: 未達成やメモなしの場合は空欄

#### 2.4.4 視覚フィードバック
- **達成済み**: 黄色の星アイコン（Sparkles）
- **未達成**: 点線枠のアイコン
- **インタラクション**: ホバー時ポインターカーソル + グロウエフェクト
- **アニメーション**: 星マークのbouncing・wiggleエフェクト

### 2.5 祝福機能（CelebrationModal）

#### 2.5.1 表示条件とコンテンツ
- **トリガー**: Do達成時に自動表示（確認モーダル後 or 直接）
- **基本コンテンツ**:
  - アニメーション付きの祝福アイコン
  - "You DID it!" タイトルメッセージ
  - 達成したDoタイトルと達成日
  - ランダム選択された祝福メッセージ
  - Twitter/X共有ボタン

#### 2.5.2 メモ入力機能
- **入力欄**: 「今日の達成メモ」ラベル付きテキストエリア
- **制限**: 200文字以内（リアルタイム文字数カウンター）
- **保存**: 「どうも！」ボタンクリック時に保存
- **任意性**: メモなしでも達成記録は保存される

#### 2.5.3 視覚効果・アニメーション
- **背景効果**: 紙吹雪エフェクト（星、きらめき、トロフィー）
- **モーダル**: スライドイン + パルス効果
- **要素**: バウンシング、スピン、フェードインエフェクト

### 2.6 メッセージシステム
- **メッセージセット**: カテゴリ別の祝福メッセージ群
- **デフォルトセット**: 10種類の日本語祝福メッセージ
- **ランダム選択**: 達成時にランダムで表示
- **ユーザー選択**: 設定でメッセージセットを選択可能
- **自動設定**: 新規ユーザー作成時にデフォルトメッセージセットを自動設定

### 2.7 設定機能

#### 2.7.1 設定画面の初期ローディング
- **初期データ取得**: ユーザー情報とメッセージセットの並列取得
- **ローディング状態管理**: データ取得完了まで適切なUI表示
- **エラーハンドリング**: 取得失敗時のフォールバック処理
- **状態同期**: データ取得後の一貫した状態管理

#### 2.7.2 プロフィール管理
- **メールアドレス表示**: 編集可能なメールアドレス表示
- **誕生日設定**: 日本語フォーマットの日付入力
- **アカウント情報表示**: 作成日・更新日の表示
- **データ整合性**: 更新時の状態同期最適化
- **エラー状態管理**: 失敗時の適切なエラー表示とクリア

#### 2.7.3 パスワード変更機能
- **セッション有効性確認**: 変更前のセッション検証
- **6文字以上の新パスワード設定**: クライアントサイドバリデーション
- **パスワード確認入力**: ミス防止のための二重入力
- **パスワード表示/非表示切り替え**: 2つの入力欄での個別制御
- **30秒タイムアウト付きAPI呼び出し**: ネットワーク遅延対策
- **包括的バリデーション**: 弱いパスワード、現在と同一パスワードの検知
- **詳細エラーメッセージ**: ユーザーフレンドリーなエラー表示
- **成功時自動リセット**: フォーム自動クリア（5秒後メッセージ消去）

#### 2.7.4 その他設定機能
- **テーマ切り替え**: ライトモード/ダークモードの即座切替
- **メッセージセット選択**: ユーザー選択可能な祝福メッセージ群
- **アカウント削除**: 確認ダイアログ付きの完全削除機能

### 2.8 テーマシステム
- **テーマ**: ライトモード、ダークモード
- **永続化**: localStorage使用
- **CSS変数**: 動的カラーシステム
- **スムーズ遷移**: アニメーション付きテーマ変更

## 3. データベース仕様

### 3.1 テーブル構成

#### profiles テーブル
```sql
- id: UUID (PRIMARY KEY, Supabase Auth User IDと同期)
- email: TEXT (Supabase Authから同期)
- birthday: DATE (任意)
- selected_message_set_id: UUID (外部キー)
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

#### dos テーブル
```sql
- id: UUID (PRIMARY KEY)
- user_id: UUID (外部キー → profiles.id)
- title: TEXT (必須)
- description: TEXT (任意)
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
- CONSTRAINT: user_id毎に最大3レコード
```

#### achievements テーブル
```sql
- id: UUID (PRIMARY KEY)
- user_id: UUID (外部キー → profiles.id)
- do_id: UUID (外部キー → dos.id)
- achieved_date: DATE
- memo: TEXT (任意、200文字制限)
- created_at: TIMESTAMP
- UNIQUE: (user_id, do_id, achieved_date)
```

#### message_sets テーブル
```sql
- id: UUID (PRIMARY KEY)
- name: TEXT (セット名)
- description: TEXT (説明)
- created_at: TIMESTAMP
```

#### praise_messages テーブル
```sql
- id: UUID (PRIMARY KEY)
- set_id: UUID (外部キー → message_sets.id)
- message: TEXT (祝福メッセージ)
- created_at: TIMESTAMP
```

### 3.2 Row Level Security (RLS) ポリシー
- **全テーブル**: RLS有効でユーザー分離を実現
- **基本ポリシー**: `auth.uid() = user_id` でユーザー別アクセス制御
- **achievements テーブル**:
  - SELECT: `auth.uid() = user_id`
  - INSERT: `auth.uid() = user_id`
  - UPDATE: `auth.uid() = user_id` (メモ機能のため必須)
  - DELETE: `auth.uid() = user_id`
- **自動更新トリガー**: updated_atフィールドの自動更新

## 4. UI/UX仕様

### 4.1 デザインシステム

#### カラーパレット
**ライトモード**:
- 背景: #F0F0F0
- プライマリテキスト: #333333
- アクセント: #FF6600
- セカンダリテキスト: #666666
- 達成星: #FFD700（金色）

**ダークモード**:
- 背景: #1A1A1A
- プライマリテキスト: #F0F0F0
- アクセント: #FF6600
- セカンダリテキスト: #999999
- 達成星: #FFD700（金色）

#### タイポグラフィ
- フォント: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif
- 日本語対応

### 4.2 レスポンシブデザイン
- **モバイルファースト**: 最小幅対応
- **タブレット・デスクトップ**: サイドバー表示
- **ブレークポイント**: Tailwind CSSの標準設定

### 4.3 アニメーション仕様

#### 星マークアニメーション
```css
bounce: 1s infinite (バウンシング)
wiggle: 0.5s ease-in-out infinite alternate (小刻み振動)
glow: box-shadow with yellow rgba
```

#### 祝福モーダルアニメーション
```css
modalSlide: 0.5s ease-out (スライドイン)
celebrationPulse: 2s ease-in-out infinite alternate (パルス)
sparkleFloat: 3-5s ease-in-out infinite (きらめき浮遊)
starTwinkle: 2-5s ease-in-out infinite (星点滅)
trophyBounce: 3-5s ease-in-out infinite (トロフィーバウンス)
```

### 4.4 ナビゲーション
- **タブ形式**: カレンダー、Do管理、設定
- **モバイル**: 折りたたみ可能サイドバー
- **状態保持**: セッション中のタブ選択状態維持
- **インタラクション**:
  - メニュー項目ホバー時の視覚エフェクト
  - マウスカーソルのポインター表示
  - 背景色とスケールアニメーション

## 5. 技術仕様

### 5.1 技術スタック
- **Frontend**: 
  - Next.js 15.3.3 (React フレームワーク)
  - React 19.0.0 (UI ライブラリ)
  - TypeScript 5 (型安全性)
- **Styling**: Tailwind CSS 4 (PostCSS 統合)
- **Backend**: Supabase (BaaS)
- **Database**: PostgreSQL (Supabase 管理)
- **Authentication**: 
  - Supabase Auth (JWT ベース)
  - @supabase/auth-ui-react 0.4.7 (UI コンポーネント)
- **Icons**: Lucide React 0.515.0
- **Date Handling**: date-fns 4.1.0 (日本語ロケール対応)
- **Development**: 
  - ESLint 9 (コード品質)
  - Next.js ESLint Config (Next.js 最適化)

### 5.2 状態管理
- **認証状態**: useAuth カスタムフック（セッション管理強化）
- **テーマ状態**: ThemeContext (React Context)
- **ローカルデータ**: useState + useEffect + useMemo最適化
- **設定画面状態管理**:
  - initialLoading状態による適切なUI制御
  - プロフィールとメッセージセットの並列データ取得
  - エラー状態の適切なクリアとフォールバック
  - 重複状態更新の排除による安定性向上

### 5.3 API通信
- **Supabase Client**: @supabase/supabase-js 2.50.0
- **エラーハンドリング強化**: 
  - try-catch-finally構文による強固な例外処理
  - セッション切れ検知（JWT/sessionエラー）
  - ネットワークエラー対応
  - ローディング状態の終了保証（finallyブロック）
  - TypeScript型安全なエラー処理（unknown型使用）
- **データ同期最適化**: 
  - リアルタイム更新（calendarRefresh トリガー）
  - 楽観的UI更新
  - エラー時の一貫性のある状態管理
  - 並列データ取得によるパフォーマンス向上
- **設定画面API最適化**:
  - Promise.allによる並列データ取得
  - 重複API呼び出しの排除
  - 適切なローディング状態管理
  - エラー時のフォールバック処理

## 6. パフォーマンス仕様

### 6.1 最適化
- **Next.js最適化**: 自動的なコード分割、画像最適化
- **CSS最適化**: Tailwind CSS purging
- **バンドルサイズ**: Next.js analyzer使用

### 6.2 キャッシュ戦略
- **静的リソース**: Next.js自動キャッシュ
- **APIレスポンス**: Supabaseのキャッシュ機能
- **ローカルストレージ**: テーマ設定のみ

## 7. セキュリティ仕様

### 7.1 認証・認可
- **JWT**: Supabase JWT トークン
- **セッション管理**: Supabase Auth自動管理
- **CSRF保護**: Next.js標準機能

### 7.2 データ保護
- **RLS**: データベースレベルのアクセス制御
- **入力検証**: クライアント・サーバー両方で実施
- **SQLインジェクション**: Supabaseクエリビルダー使用で防止

## 8. 制約・前提条件

### 8.1 機能制約
- **Do数上限**: 1ユーザーあたり3つまで
- **達成記録**: 1日1Doあたり1回まで（重複制約で保証）
- **メモ文字数**: 200文字以内（達成メモ）
- **確認モーダル表示**: 30%の確率でランダム表示
- **メッセージセット**: 管理者による事前設定が必要

### 8.2 技術制約
- **ブラウザ対応**: モダンブラウザ（ES6+対応）
- **JavaScript**: 必須（無効では動作不可）
- **ネットワーク**: インターネット接続必須

### 8.3 スケーラビリティ
- **ユーザー数**: Supabaseの制限に準拠
- **データ量**: 1ユーザーあたり年間約1000レコード（想定）

## 9. 今後の拡張可能性

### 9.1 機能拡張案
- **統計・分析機能**: 
  - 達成率グラフ・継続日数カウント
  - 月次・年次レポート
  - メモ傾向分析
- **通知機能**: リマインダー、励ましメッセージ
- **ソーシャル機能**: 友達とのDo共有、チーム機能
- **カスタマイズ機能**: 
  - ユーザー独自の祝福メッセージ作成
  - メモテンプレート機能

### 9.2 技術的拡張
- **PWA化**: オフライン対応、プッシュ通知
- **多言語対応**: 国際化（i18n）
- **アプリ化**: React Native、Electron

---

**文書バージョン**: 1.6  
**最終更新日**: 2025年6月22日  
**作成者**: Claude Code Assistant

## 更新履歴

### v1.1 (2025年6月16日)
- 認証機能にセッション管理機能を追加
- 達成記録機能にランダム確認機能を追加
- UI/UXにマウスカーソル対応とメニューエフェクトを追加
- 日付選択状態の保持機能を追加

### v1.2 (2025年6月17日)
- 達成記録メモ機能を追加（200文字制限）
- 達成記録削除機能を追加（確認ダイアログ付き）
- カレンダー下Doリストでメモ表示機能を追加
- お祝いモーダルにメモ入力欄を追加
- データベースにmemoフィールドを追加
- Row Level Security (RLS) のUPDATEポリシーを追加

### v1.3 (2025年6月18日)
- アカウント作成成功時の確認メッセージ機能を追加
- 新規ユーザーにデフォルトメッセージセット自動設定機能を追加
- パスワード表示/非表示切り替え機能を追加（アイコンボタン）
- ログアウト機能のエラーハンドリングを改善
- 認証メールURLの本番環境対応を考慮
- ページリロード時の安定性を改善（finallyブロックでローディング状態終了保証）
- カレンダーDo表示のデータ同期を安定化（エラー時の空配列セット）

### v1.4 (2025年6月19日)
- 読み込みタイムアウト問題を修正（10秒→20秒に延長）
- 認証エラー時の自動ログイン画面リダイレクト機能を追加
- ログアウト後の確実なログイン画面リダイレクト機能を追加
- API呼び出しのタイムアウト設定を追加（Realtime: 30秒）
- セッション管理機能を強化（自動トークン更新、永続化）

### v1.5 (2025年6月19日)
- パスワード変更機能を設定画面に追加
- セッション有効性確認による安全なパスワード変更
- パスワード表示/非表示切り替え機能（2つの入力欄）
- 30秒タイムアウト機能付きAPI呼び出し
- 詳細なバリデーション（6文字以上、確認一致、現在と異なる等）
- 包括的エラーハンドリング（タイムアウト、セッション切れ、弱いパスワード等）
- 成功時の自動フォームリセット機能（5秒後メッセージ消去）
- 設定画面のセクション順序を最適化（テーマ→メッセージ→プロフィール→パスワード→アカウント）

### v1.6 (2025年6月22日)
- 設定画面のユーザー情報取得処理を安定化リファクタリング
- initialLoading状態による適切な初期ローディングUI実装
- プロフィールとメッセージセットの並列データ取得によるパフォーマンス向上
- 重複状態更新の排除（プロフィール更新後の不要な状態設定除去）
- エラーハンドリング強化（エラー時の適切な状態クリアとフォールバック）
- TypeScript型安全性向上（unknown型使用によるエラー処理最適化）
- useEffect依存関係の最適化による不要な再レンダリング防止
- 設定画面の安定性向上（再読み込み不要な安定したデータ取得）